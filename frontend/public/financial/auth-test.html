<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Flow Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .test-section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .test-pass { color: green; font-weight: bold; }
        .test-fail { color: red; font-weight: bold; }
        .test-skipped { color: orange; }
        .log { font-family: monospace; background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Authentication Flow Test</h1>
        
        <div class="test-section">
            <h3>1. Check Initial State</h3>
            <div id="initial-state">
                <p>Checking if user is already authenticated...</p>
            </div>
        </div>

        <div class="test-section">
            <h3>2. Test Login</h3>
            <button id="login-btn" class="btn btn-primary" disabled>Login with Google</button>
            <div id="login-result" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h3>3. Test Protected API Call</h3>
            <button id="api-test-btn" class="btn btn-secondary" disabled>Test Protected API</button>
            <div id="api-test-result" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h3>4. Test Logout</h3>
            <button id="logout-btn" class="btn btn-danger" disabled>Logout</button>
            <div id="logout-result" class="mt-3"></div>
        </div>

        <div class="test-section">
            <h3>Test Logs</h3>
            <div id="test-logs" class="log"></div>
        </div>
    </div>

    <script>
        // Log function to display test results
        function log(message, type = 'info') {
            const logDiv = document.getElementById('test-logs');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${new Date().toISOString()}] ${message}`;
            logDiv.prepend(logEntry);
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Check if token exists in localStorage
        function checkAuthState() {
            const token = localStorage.getItem('token');
            const stateDiv = document.getElementById('initial-state');
            
            if (token) {
                stateDiv.innerHTML = `
                    <p class="test-pass">✓ User is already authenticated</p>
                    <p>Token: ${token.substring(0, 20)}...</p>
                `;
                document.getElementById('login-btn').disabled = true;
                document.getElementById('api-test-btn').disabled = false;
                document.getElementById('logout-btn').disabled = false;
            } else {
                stateDiv.innerHTML = '<p class="test-skipped">User is not authenticated</p>';
                document.getElementById('login-btn').disabled = false;
                document.getElementById('api-test-btn').disabled = true;
                document.getElementById('logout-btn').disabled = true;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthState();
            
            // Login button click handler
            document.getElementById('login-btn').addEventListener('click', () => {
                log('Redirecting to Google OAuth...');
                window.location.href = '/auth/google';
            });

            // Test protected API button click handler
            document.getElementById('api-test-btn').addEventListener('click', async () => {
                const resultDiv = document.getElementById('api-test-result');
                resultDiv.innerHTML = '<p>Testing protected API call...</p>';
                
                try {
                    const response = await fetch('/api/user/me', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <p class="test-pass">✓ Protected API call successful!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Protected API call successful');
                } catch (error) {
                    resultDiv.innerHTML = `
                        <p class="test-fail">✗ Protected API call failed: ${error.message}</p>
                    `;
                    log(`Protected API call failed: ${error.message}`, 'error');
                }
            });

            // Logout button click handler
            document.getElementById('logout-btn').addEventListener('click', () => {
                log('Logging out...');
                localStorage.removeItem('token');
                const resultDiv = document.getElementById('logout-result');
                resultDiv.innerHTML = '<p class="test-pass">✓ Successfully logged out</p>';
                checkAuthState();
                log('User logged out');
            });

            // Check for token in URL (in case of OAuth callback)
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            if (token) {
                log('Token received from OAuth callback');
                localStorage.setItem('token', token);
                
                // Clean up URL
                const url = new URL(window.location);
                url.searchParams.delete('token');
                window.history.replaceState({}, '', url);
                
                // Update UI
                checkAuthState();
                document.getElementById('login-result').innerHTML = `
                    <p class="test-pass">✓ Successfully authenticated with Google!</p>
                    <p>Token stored in localStorage</p>
                `;
            }
        });
    </script>
</body>
</html>
